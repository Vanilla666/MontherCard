<!DOCTYPE html>
<html lang="en">

<head>

    <meta property="og:type" content="website" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>中國信託銀行母親賀卡</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
        crossorigin="anonymous">
    <!-- Bootstrap CSS -->
</head>
<style>
    .resize-drag {
        position: absolute;
        touch-action: none;
        top: 30%;
        left: 35%;
        width: 31%;
        height: 21%;
        /* background-color: blue; */
    }

    .resize-container {
        /* 最大的div把圖片成功合成 */
        position: relative;
        width: 100%;
        /* 769 */
        height: 100%;
        /* 960 */
    }

    #back {
        /* 固定的背景 */
        display: inline-block;
        width: 100%;
        height: 100%;
    }

    #portrait {
        /* 被控制的圖片 */
        z-index: -1;
        top: 30%;
        left: 35%;
        background-color: rgb(58, 238, 34);
        border-radius: 8px;
        position: absolute;
        width: 30%;
        height: 20%;
        /* 30 20*/
    }

    .bgimg_ciclk {
        /* 選擇背景btn */
        top: 90%;
        left: 40%;
        position: absolute;
    }

    .upload_set {
        /* 控制上傳檔案的框 */
        z-index: 2;
        top: 125%;
        left: 20%;
        position: absolute;
    }
    @media screen and (max-width: 640px) {
        /*  X<640 手機尺寸 */
        /* body {
            background-color: aqua;
        } */
        .upload_set {
            /* 控制上傳檔案的框 */
            z-index: 2;
            top: 115%;
            left: 10%;
            position: absolute;
        }
    }

    @media screen and (min-width: 641px) and (max-width: 980px) {
        /*  641<X<980 平板尺寸 */
        /* body {
            background-color: blueviolet;
        } */
        .upload_set {
            /* 控制上傳檔案的框 */
            /* z-index: 2; */
            top: 135%;
            left: 17.5%;
            position: absolute;
        }
    }

    @media screen and (min-width: 981px) and (max-width: 1920px) {
        /*  981<X<1920 電腦尺寸 */
        /* body {
            background-color: rgb(150, 179, 25);
        } */
    }

    /* .carousel-control-next-icon{
        background:red; 
    } */

    /* 限制大小的css*/
</style>

<body>


    <div id="all_btn">
        <button onclick="FB_link()">點我分享到FB</button>
        <button onclick="Line_link()">點我分享到LINE</button>
        <button onclick="load_img()" type="button">讀取放在imgurl</button>
        <button onclick="alink()" type="button">換到讀取頁</button>
        <button onclick="down()" type="button">確認送出</button>
    </div>

    <div id="carouselExampleControls" class="carousel slide" data-ride="carousel">
        <div class="carousel-inner">

            <div class="carousel-item active">
                <fieldset class="bgimg_ciclk">
                    <input type="button" value="選擇背景" onclick="showPreview(this,1,'back')">
                    <legend>背景圖</legend>
                </fieldset>

<<<<<<< HEAD:index.html
                <img id="bg1" class="d-block w-100" src="img\b1.png" alt="First slide" onclick="showPreview(this, 1,'back')">
=======
                <img id="bg1" class="d-block w-100" src="img\b1.png"
                    alt="First slide" onclick="showPreview(this, 1,'back')">
>>>>>>> f95148db1e8ad5d0fd7c3351b6700f863d8751e0:index.html
            </div>

            <div class="carousel-item">
                <fieldset class="bgimg_ciclk">
                    <input type="button" value="選擇背景" onclick="showPreview(this,3,'back')">
                    <legend>背景圖</legend>
                </fieldset>
<<<<<<< HEAD:index.html
                <img id="bg2" class="d-block w-100" src="img\b2.png" alt="Second slide" onclick="showPreview(this, 3,'back')">
=======
                <img id="bg2" class="d-block w-100" src="img\b2.png"
                    alt="Second slide" onclick="showPreview(this, 3,'back')">
>>>>>>> f95148db1e8ad5d0fd7c3351b6700f863d8751e0:index.html
            </div>

            <div class="carousel-item">
                <fieldset class="bgimg_ciclk">
                    <input type="button" value="選擇背景" onclick="showPreview(this,5,'back')">
                    <legend>背景圖</legend>
                </fieldset>
<<<<<<< HEAD:index.html
                <img id="bg3" class="d-block w-100" src="img\b3.png" alt="Third slide" onclick="showPreview(this, 5,'back')">
=======
                <img id="bg3" class="d-block w-100" src="img\b3.png"
                    alt="Third slide" onclick="showPreview(this, 5,'back')">
>>>>>>> f95148db1e8ad5d0fd7c3351b6700f863d8751e0:index.html
            </div>
            <div class="carousel-item">
                <fieldset class="bgimg_ciclk">
                    <input type="button" value="選擇背景" onclick="showPreview(this,7,'back')">
                    <legend>背景圖</legend>
                </fieldset>
<<<<<<< HEAD:index.html
                <img id="bg4" class="d-block w-100" src="img\b4.png" alt="Third slide" onclick="showPreview(this, 7,'back')">
=======
                <img id="bg4" class="d-block w-100" src="img\b4.png"
                    alt="Third slide" onclick="showPreview(this, 7,'back')">
>>>>>>> f95148db1e8ad5d0fd7c3351b6700f863d8751e0:index.html
            </div>
            <div class="carousel-item">
                <fieldset class="bgimg_ciclk">
                    <input type="button" value="選擇背景" onclick="showPreview(this,9,'back')">
                    <legend>背景圖</legend>
                </fieldset>
<<<<<<< HEAD:index.html
                <img id="bg5" class="d-block w-100" src="img\b5.png" alt="Third slide" onclick="showPreview(this, 9,'back')">
=======
                <img id="bg5" class="d-block w-100" src="img\b5.png"
                    alt="Third slide" onclick="showPreview(this, 9,'back')">
>>>>>>> f95148db1e8ad5d0fd7c3351b6700f863d8751e0:index.html
            </div>
            <div class="carousel-item">
                <fieldset class="bgimg_ciclk">
                    <input type="button" value="選擇背景" onclick="showPreview(this,11,'back')">
                    <legend>背景圖</legend>
                </fieldset>

<<<<<<< HEAD:index.html
                <img id="bg6" class="d-block w-100" src="img\b6.png" alt="Third slide" onclick="showPreview(this, 11,'back')">
=======
                <img id="bg6" class="d-block w-100" src="img\b6.png"
                    alt="Third slide" onclick="showPreview(this, 11,'back')">
>>>>>>> f95148db1e8ad5d0fd7c3351b6700f863d8751e0:index.html
            </div>


            <a class="carousel-control-next" href="#carouselExampleControls" role="button" data-slide="next">
                <!-- 後面箭頭 -->
                <!-- <span class="carousel-control-next-icon" aria-hidden="true"></span> -->
                <img src="https://xinyan.000webhostapp.com/Mother/bg/icon-arrow-right-b-128.png" class="carousel-control-next-icon" aria-hidden="true">
                </span>
                <span class="sr-only">Next</span>
            </a>
        </div>
        <a class="carousel-control-prev" href="#carouselExampleControls" role="button" data-slide="prev">
            <!-- <span class="carousel-control-prev-icon" aria-hidden="true"></span> -->
            <!-- 前面箭頭 -->
            <img src="https://xinyan.000webhostapp.com/Mother/bg/icon-arrow-left-b-128.png" class="carousel-control-next-icon" aria-hidden="true">
            </span>
            <span class="sr-only">Previous</span>
        </a>
    </div>

    <!-- <img id="aaa"> -->
    <div id="info">
        <div id="angle-info">0&deg;</div>
        <div id="cellphono_info"></div>
        <div id="scale_info"></div>
    </div>
    <!-- <div class="line-it-button" data-lang="zh_Hant" data-type="share-c" data-ver="2" data-url="https://imgur.com/w8DrJvL" style="display: none;"></div> -->

    <!-- <div id="poster"> </div> -->
    <div id="img_load">
        <fieldset>
            <input type="file" id="file" onchange="fileshow(this,'portrait')" />
            <button onclick="down()" type="button">確認送出</button>
        </fieldset>
        <div class="resize-container">
            <img id="back" />
            <!-- 背景 -->
            <div id="contoller" class="resize-drag"></div>
            <img id="portrait" />
            <!-- 上傳的圖片 -->
        </div>

        </canvas>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/interactjs@1.3.4/dist/interact.min.js"></script>
<!-- interact 引用縮放拖曳套件 -->
<!-- <script src="https://cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script> -->
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<!-- 引用jq -->
<script src="https://cdn.bootcss.com/html2canvas/0.5.0-beta4/html2canvas.min.js"></script>
<!-- html2canvas這個插件的方法，可以將整個節點繪製成畫布 -->
<script async defer src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v3.2"></script>
<!-- FB SDK  -->
<script src="https://d.line-scdn.net/r/web/social-plugin/js/thirdparty/loader.min.js" async="async" defer="defer"></script>
<!--  LINE social-plugin -->
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<!-- axios -->
<!-- <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
    crossorigin="anonymous"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>
<script>
    var scale = 1,
        gestureArea = document.getElementById('contoller'), /*控制圖片的div*/
        scaleElement = document.getElementById('portrait'); /* 被控制的img */
    let complete_img; //完整的圖片URL
    var img; //圖片拿出
    var bg_img; //選到的背景資訊
    document.getElementById("info").hidden = true; //info hidden
    // document.getElementById("all_btn").hidden = true;//btn hidden
    document.getElementById("img_load").hidden = true;//合成圖片區域 hidden
    function showPreview(source, imgId, back) { //上傳圖片 imgId = 第幾張背景
        // var img = new Image();
        console.log(event.target.src);
        var x = imgId; //這裡要拿到哪一張圖
        var info = document.getElementsByClassName("carousel-item");
        bg_img = $(info).children().get(x).src; //給到外面變數
        getCanvasBase64(bg_img) /* 把背景轉base64才能做合成 */
            .then(function (base64) {
                console.log("方式二》》》》》》》》》", base64);
                document.getElementById(back).src = base64; //選到的背景放入back
            }, function (err) {
                console.log(err);
            });
        var s = document.getElementById("carouselExampleControls").hidden = true; //拿到背景後影藏
        document.getElementById("img_load").hidden = false;
    }
    function getCanvasBase64(img) {
        var image = new Image();
        //至關重要
        image.crossOrigin = '';
        image.src = img;
        //至關重要
        var deferred = $.Deferred();
        if (img) {
            image.onload = function () {
                deferred.resolve(getBase64Image(image));//將base64傳給done上傳處理
                // document.getElementById("container2").appendChild(image);
            }
            return deferred.promise();//問題要讓onload完成後再return sessionStorage['imgTest']
        }
    }
    function getBase64Image(img, width, height) {
        var canvas = document.createElement("canvas");
        canvas.width = width ? width : img.width;
        canvas.height = height ? height : img.height;
        var ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        var dataURL = canvas.toDataURL();
        return dataURL;
    }
    function fileshow(source, imgId) { //上傳圖片 this替代成 source 指的這個input 
        // console.log( $(source).children() );
        var file = source.files[0]; //傳進的檔案
        if (window.FileReader) {
            var fr = new FileReader(); //開啟檔案
            fr.onloadend = function (e) { //讀檔放入 背景沒有這樣做所以沒有合成成功
                console.log(e.target.result);
                document.getElementById(imgId).src = e.target.result; // 放到DOM元素 = 當前傳進的目標
            }
            fr.readAsDataURL(file); // 即將被讀取的Blob或File對象
        }
    }
    function down() { //這個函數是點擊下載執行的方法
        html2canvas($(".resize-container"), { //這是使用了html2canvas這個插件的方法，將class為resize-container的整個節點繪製成畫布
            // useCORS: true,
            onrendered: function (canvas) { //畫布繪製完成後執行下面內容，function內的canvas這個參數就是已經被繪製成畫布
                var file = canvas.toDataURL(); //預設是png圖片 base64  
                // img = file;//圖片拿出
                console.log("asd", file); //印出合成的圖片
                ajaxUpLoad(file);//發送base64前端圖片 
            },
        }).then((canvas) => {
            document.body.appendChild(canvas);
        });
    };
    function ajaxUpLoad(file) { // file = base64的前端img
        $.ajax({
            type: "POST",
            url: 'http://211.23.17.100:3005', // 這裡打KOA後端
            async: true,
            data: { img: file }, // img(key):file(value)
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            success: function (data) { //拿到成功的存儲圖片(http) 
                console.log("成功: ", data.url);//data.url = 合成好的圖片
                localStorage.CombinePicture = data.url; //把合成好的圖片丟入到 localStorage
                console.log(" 合成好的圖片 ", localStorage.CombinePicture);//印出localStorage.CombinePicture
            },
            error: function (err) {
                console.log("錯誤: ", err);
            }
        });
    }
    function load_img() {
        const self = this;
        let settings = {
            headers: {
                Authorization: 'Bearer ' + token
            },
            async: true,
            crossDomain: true,
            url: "https://api.imgur.com/3/album/" + album + "/images", //可以拿到上面總共的img
            method: "GET",
        };
        $.ajax(settings).then(
            function (res) {
                var x = document.getElementById("aaa");
                console.log(" 所有圖片: ", res.data); // 可以看見上傳成功後回的值
                if (complete_img == null) {
                    complete_img = "https://i.imgur.com/" + res.data.pop().id;
                } else {
                    x.src = complete_img;  //完整的圖片URL
                }
                // alert('上傳完成，稍待一會兒就可以在底部的列表上看見了。')
            });
    }
    function alink() {
        window.location = "https://xinyan.000webhostapp.com/Mother/recive.html";
    }
    this.location.src = img; //改變預設圖片
    function Line_link() {
        var test = "https://imgur.com/w8DrJvL"; //生成的圖片 (暫時拿我從imgrl的img)
        var x = encodeURIComponent(test); // 轉utf8
        // this.location.src = test; //改變預設圖片
        console.log("asdsad", this.location.src, "this Link: ", this.location.href); //改變
        // var link = "https://xinyan.000webhostapp.com/Mother/test.html";
        var link = this.location.src;
        var c = encodeURIComponent(link); //連接
        var line_link = "https://social-plugins.line.me/lineit/share?url=" + this.location.href;
        // var line_test = https://social-plugins.line.me/lineit/share?url=https://imgur.com/w8DrJvL&text=https://xinyan.000webhostapp.com/Mother/test.html;
        location.href = line_link; //跳轉
        return false;
    };
    function FB_link() { //FB分享
        $.ajaxSetup({
            cache: true
        });
        // 取得臉書提供API
        $.getScript('//connect.facebook.net/en_UK/all.js', function () {
            // Load the APP / SDK
            FB.init({
                appId: '2088163627887886',  // FB APPID
                cookie: true, // set sessions cookies to allow your server to access the session?
                status: true, // check the login status upon init?
                xfbml: true, // parse XFBML tags on this page?
                frictionlessRequests: true,
                oauth: true,
                version: 'v3.2'
            });
            FB.login(function (response) { //FB 登入
                if (response.authResponse) {
                    FB.api('/me', function (response) { //打路由　
                        console.log('Good to see you, ' + response.name + '.');
                    });
                    console.log(response.authResponse);　//吐回應資訊
                    window.authToken = response.authResponse.accessToken; //FB 
                    // 網頁轉圖片分享至臉書
                    FB.ui({
                        method: 'share',
                        href: 'https://developers.facebook.com/docs/',　//imgurl
                    }, function (response) {
                        console.log(response); //回應訊息
                    });
                    // PostImageToFacebook(window.authToken);
                }
            })
        })
    }
    function PostImageToFacebook(authToken) { //分享到ＦＢ
        // complete_img 完整圖片 URL
        console.log("FB　token: " + authToken + "img URL: " + complete_img); // OK
        var fd = new FormData(); //一個新的form 
        fd.append("access_token", authToken); //FB 登入後的toekn
        fd.append("source", complete_img); // 圖片 complete_img
        fd.append("message", "這是一個測試臉書分享圖片功能"); // message
        // FB.ui({
        //     method: 'share',
        //     href: 'https://developers.facebook.com/docs/',　//imgurl
        // }, function (response) {
        //     console.log(response); //回應訊息
        // });
        try {
            $.ajax({
                url: "https://graph.facebook.com/me/photos?access_token=" + authToken,//這裡怪怪的 傳送的url
                type: "POST",
                data: fd, //傳送的資料
                processData: false,
                contentType: false,
                cache: false,
                success: function (data) {
                    console.log("success " + data);　//成功時印出來
                    $("#poster").html("Posted Canvas Successfully");
                    alert("以分享至臉書，請至臉書查看最新消息!!");
                },
                error: function (shr, status, data) { //　錯誤印出
                    console.log("error " + data + " Status " + shr.status);
                },
                complete: function () {
                    console.log("Posted to facebook");　//完成時　印出
                }
            });
        } catch (e) {
            console.log(e);
        };
    }
    interact(gestureArea)
        .gesturable({ //開始變形時
            onmove: function (event) { //開始變形(雙指放大 縮小)所作函數   event = gestureArea
                var target = event.target;
                scale = scale * (1 + event.ds);
                document.getElementById("scale_info").innerHTML = "  縮放時: " + scale;
                // target.style.webkitTransform = contoller_img.style.webkitTransform = 'translate(' + outer_x + 'px, ' + outer_y + 'px)'; // 控制圖片div 跟圖片一起 設定x,y軸屬性
                target.style.transform = scaleElement.style.transform = 'scale(' + scale + ')'; // 當前變形的角度         
                //gestureArea.style.transform = scaleElement.style.transform = 'translate(' + outer_x + 'px, ' + outer_y + 'px)'; // 控制圖片div 跟圖片一起 設定x,y軸屬性
                dragMoveListener(event); //加上 拖曳X,Y軸更新 藍色方框不同步
            },
        })
        .draggable({ onmove: dragMoveListener }); //拖曳時所作函數 要加上 變化的角度(函數)
    function dragMoveListener(event) {
        var target = event.target,
            // keep the dragged position in the data-x/data-y attributes
            x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
            y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
        document.getElementById("cellphono_info").innerHTML = "x :" + x + "y :" + y;
        target.style.webkitTransform = scaleElement.style.transform = 'translate(' + x + 'px, ' + y + 'px)';
        // // update the posiion attributes
        target.setAttribute('data-x', x);
        target.setAttribute('data-y', y);
    }
    function reset() {
        scale = 1;
        scaleElement.style.webkitTransform =
            scaleElement.style.transform =
            'scale(1)';
    }
</script>

</html>
