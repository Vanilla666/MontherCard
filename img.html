<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<style>
    .resize-drag {
        /* 拖曳旋轉太快 還有Z軸問題 */
        /* z-index: 1; */
        position: absolute;
        background-color: #29e;
        color: white;
        border-radius: 8px;
        padding: 10px;
        touch-action: none;

        /* This makes things much easier */
        box-sizing: border-box;
        /* margin會被拿掉後顯示 */
        /*  */
        top: 38%;
        /* bottom: 40%; */
        left: 38%;
        right: 50%;
        width: 25%;
        height: 25%;

    }

    .resize-container {
        position: relative;
        width: 769px;
        height: 960px;
    }

    #back {
        /* z-index: 0; */
        position: relative;
        width: 100%;
        height: 100%;
        /* background: blue; */
    }


    /* 限制大小的css*/
</style>

<body>
    <fieldset>
        <legend>中間藍色 </legend>
        <input type="file" id="file" onchange="showPreview(this,'portrait')" />
    </fieldset>
    <fieldset>
        <input type="file" onchange="showPreview(this,'back')">
        <legend>背景圖 </legend>
    </fieldset>
    <button onclick="down()" type="button">按下後結合圖片</button>
    <button onclick="combine()" type="button" class="mui-btn mui-btn-blue mui-btn-block">按钮</button>
    <div id="angle-info">0&deg;</div>
    <!-- this 指的是input這個DOM元素-->
    <div class="resize-container">
        <img id="back" />
        <!-- 背景 -->
        <img class="resize-drag" id="portrait" />
        <!-- 上傳的圖片 -->
    </div>
    <canvas id="myCanvas" width="270" height="135" style="border:1px solid #d3d3d3;"></canvas>

</body>
<script src="https://cdn.jsdelivr.net/npm/interactjs@1.3.4/dist/interact.min.js"></script>
<!-- interact 引用縮放拖曳套件 -->
<script src="https://cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>
<!-- 引用jq -->
<script src="https://cdn.bootcss.com/html2canvas/0.5.0-beta4/html2canvas.min.js"></script>
<!-- html2canvas這個插件的方法，可以將整個節點繪製成畫布 -->
<script>
    function down() { //這個函數是點擊下載執行的方法
        html2canvas($(".resize-container"), { //這是使用了html2canvas這個插件的方法，將class為resize-container的整個節點繪製成畫布
            onrendered: function (canvas) { //畫布繪製完成後執行下面內容，function內的canvas這個參數就是已經被繪製成畫布 
                var link = document.createElement('a');//創建一個a標籤
                link.download = 'my-image-name.jpg';//a標籤增加一個download屬性，屬性值（my-image-name.jpg）就是合成下載後的文件名
                link.href = canvas.toDataURL();//canvas.toDataURL()就是畫布的路徑，將路徑賦給a標籤的href
                console.log("URL: ", link.href);
                link.click();//模擬a標籤被點擊，這樣就可以下載了
            },
        })
    }
    function combine() { //放置圖片位置會因為上傳大小導致放的地方有誤差
        // console.log("mmm")
        var back = document.getElementById("back");//背景
        var canvas = document.getElementById("myCanvas"); //canvas
        canvas.width = back.width; //canvas 的寬 = 背景的寬
        canvas.height = back.height; //canvas 的高 = 背景的高
        var ctx = canvas.getContext("2d");//canvas必須打
        ctx.drawImage(back, 0, 0, back.width, back.height); //canvas畫出背景圖

        var upload_img = document.getElementById("portrait");//上傳的圖片
        ctx.drawImage(upload_img, 0, 0, upload_img.width, upload_img.height, (back.width / 2) - 80, (back.height / 2) - 50, upload_img.width, upload_img.height); //canvas畫出上傳的圖 做成疊圖

        // srccc = canvas.toDataURL("image/jpeg", 0.8);
        // console.log(srccc);
    }
    function showPreview(source, imgId) { //上傳圖片
        // console.log(source);
        var file = source.files[0];
        if (window.FileReader) {
            var fr = new FileReader();
            fr.onloadend = function (e) {
                document.getElementById(imgId).src = e.target.result; //把讀取到的照片放打imgID裡當來源
            }
            fr.readAsDataURL(file);
        }
    }

    interact('.resize-drag') //引用套件到 img class resize-drag

        .resizable({ //圖片調整大小的地方
            // resize from all edges and corners
            edges: { left: true, right: true, bottom: true, top: true },

            // keep the edges inside the parent
            restrictEdges: {
                outer: 'parent',
                endOnly: true,
            },

            // minimum size
            restrictSize: {
                // min: { width: 100, height: 50 }, //最小限制
                // max: { width: 200, height: 100 } //最大限制
            },

            inertia: true,
        })

        .on('resizemove', function (event) { //圖片拉動
            var target = event.target,
                x = (parseFloat(target.getAttribute('data-x')) || 0),
                y = (parseFloat(target.getAttribute('data-y')) || 0);

            // update the element's style
            target.style.width = event.rect.width + 'px';//畫面當前最大寬度
            target.style.height = event.rect.height + 'px';//畫面當前限制最大高度
            // console.log("畫面當前最大寬度:", target.style.width, "畫面當前限制最大高度:", target.style.height);
            // translate when resizing from top or left edges
            x += event.deltaRect.left;
            y += event.deltaRect.top;

            target.style.webkitTransform = target.style.transform =
                'translate(' + x + 'px,' + y + 'px)';

            target.setAttribute('data-x', x);
            target.setAttribute('data-y', y);
            // console.log(target);
            target.textContent = Math.round(event.rect.width) + '\u00D7' + Math.round(event.rect.height);
        });

    interact('.resize-drag') //重新引用套件去做拖曳這件事
        .draggable({ //拖曳事件
            // enable inertial throwing
            inertia:true, 
            // keep the element within the area of it's parent
            restrict: { //限制伸縮大小

                restriction: "parent",
                endOnly: true, //endOnly選項進行捕捉或限制
                elementRect: { top: 0.5, left: 0.5, bottom: 0.5, right: 0.5 } //處碰性能
            },
            // enable autoScroll
            autoScroll: true,

            // call this function on every dragmove event
            onmove: dragMoveListener, //onmove 上增加拖曳函數

        });

    function dragMoveListener(event) { //拖曳函數
        var target = event.target,//指定到當前使用的目標
            // keep the dragged position in the data-x/data-y attributes
            x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,//重新設定x軸屬性 
            y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;//重新設定y軸屬性

        // translate the element
        target.style.webkitTransform =
            target.style.transform =
            'translate(' + x + 'px, ' + y + 'px)'; //設定x,y軸屬性
        console.log(target.style.webkitTransform); //顯示設定的屬性
        // update the posiion attributes
        target.setAttribute('data-x', x);//重新data-x更新屬性
        target.setAttribute('data-y', y);//重新data-y更新屬性
    }
    window.dragMoveListener = dragMoveListener; //給瀏覽器拖動增加事件(dragMoveListener)

    var angle = 0; //角度
    interact('.resize-drag').gesturable({ // 圖片外框  圖片旋轉
        onmove: function (event) {
            var arrow = document.getElementById('portrait'); //圖片

            angle += event.da;

            arrow.style.webkitTransform =
                arrow.style.transform =
                'rotate(' + angle + 'deg)';
            
            document.getElementById('angle-info').textContent =
                angle.toFixed(2) + '\u00b0';
        }
    });


</script>

</html>