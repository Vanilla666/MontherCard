<!DOCTYPE html>
<html lang="en">

<head>
    <meta property="og:title" content="週年慶週週抽" />

    <meta property="og:description" content="凡上網參加活動即可獲抽獎資格" />

    <meta property="og:url" content="https://xinyan.000webhostapp.com/Mother/img.html" />

    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://xinyan.000webhostapp.com/Mother/girl.png" />
    <meta property="og:image" content="https://xinyan.000webhostapp.com/Mother/girl.png" />

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<style>
    .resize-drag {
        /* 控制圖片的div */
        /* 拖曳旋轉太快  */
        position: absolute;
        background-color: #29e;
        /* 控制圖片的div */
        /* color: white; */
        /* border-radius: 8px; */
        /* padding: 10px; */
        touch-action: none;
        /* display: inline-block; */
        /* This makes things much easier */
        /* box-sizing: border-box; */
        /* margin會被拿掉後顯示 */
        /*  */
        top: 38%;
        /* bottom: 40%; */
        left: 38%;
        /* right: 50%; */
        width: 25%;
        height: 25%;

    }

    .resize-container {
        /* 最大的div把圖片成功合成 */
        position: relative;
        width: 769px;
        height: 960px;
    }

    #back {
        /* 固定的背景 */
        /* z-index: 0; */
        display: inline-block;
        /* position: relative; */
        width: 100%;
        height: 100%;
        /* background: blue; */
    }

    #portrait {
        /* 被控制的圖片 */
        z-index: -1;
        /* 把圖片放到最下層 */
        top: 38%;
        /* bottom: 40%; */
        left: 38%;
        /* right: 50%; */
        background-color: rgb(58, 238, 34);
        /* display: inline-block; */
        /* color: white; */
        border-radius: 8px;
        /* padding: 10px; */
        position: absolute;
        width: 30%;
        height: 30%;
    }

    /* 限制大小的css*/
</style>

<body>

    <fieldset>
        <legend>中間藍色 </legend>
        <input type="file" id="file" onchange="showPreview(this,'portrait')" />
    </fieldset>
    <fieldset>
        <input type="file" onchange="showPreview(this,'back')">
        <legend>背景圖 </legend>
    </fieldset>
    <button onclick="FB_link()">點我分享到FB</button>
    <button onclick="Line_link()">點我分享到LINE</button>
    <button onclick="down()" type="button">按下後結合圖片</button>
    <button onclick="combine()" type="button">按钮</button>
    <div id="angle-info">0&deg;</div>
    <div id="cellphono_info"></div>
    <div id="scale_info"></div>
    <!-- this 指的是input這個DOM元素-->
    <div class="resize-container">
        <img id="back" />
        <!-- 背景 -->

        <div id="contoller" class="resize-drag"></div>
        <img id="portrait" />
        <!-- 上傳的圖片 -->

    </div>
    <canvas id="myCanvas" width="270" height="135" style="border:1px solid #d3d3d3;"></canvas>

</body>
<script src="https://cdn.jsdelivr.net/npm/interactjs@1.3.4/dist/interact.min.js"></script>
<!-- interact 引用縮放拖曳套件 -->
<script src="https://cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>
<!-- 引用jq -->
<script src="https://cdn.bootcss.com/html2canvas/0.5.0-beta4/html2canvas.min.js"></script>
<!-- html2canvas這個插件的方法，可以將整個節點繪製成畫布 -->
<script async defer src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v3.2"></script>
<!-- FB SDK  -->
<script>


    var scale = 1,
        gestureArea = document.getElementById('contoller'), /*控制圖片的div*/
        scaleElement = document.getElementById('portrait'), /* 被控制的img */
        resetTimeout,
        outer_x = 0, outer_y = 0, outer_scale = 0;

    interact(gestureArea)
        .gesturable({ //開始變形時
            // onstart: function (event) { //準備開始  event = gestureArea
            //     clearTimeout(resetTimeout);
            //     scaleElement.classList.remove('reset');
            // },
            onmove: function (event) { //開始變形(雙指放大 縮小)所作函數   event = gestureArea
                scale = scale * (1 + event.ds);
                document.getElementById("scale_info").innerHTML = scale;
                gestureArea.style.transform = scaleElement.style.transform =
                    'scale(' + scale + ')'; // 當     前變形的角度
                // gestureArea.style.transform = scaleElement.style.transform = 'translate(' + outer_x + 'px, ' + outer_y + 'px)'; // 控制圖片div 跟圖片一起 設定x,y軸屬性
                // dragMoveListener(event); //加上 拖曳X,Y軸更新 藍色方框不同步
            },
            // onend: function (event) { //變形結束 event = gestureArea
            //     resetTimeout = setTimeout(reset, 1000);
            //     scaleElement.classList.add('reset');
            // }
        })
        .draggable({ onmove: dragMoveListener }); //拖曳時所作函數 要加上 變化的角度(函數)

    function dragMoveListener(event) { //拖曳函數 event 指的是resize-drag
        var contoller_img = document.getElementById("contoller"); //拿到div
        contoller_img = $(contoller_img).next().get(0); //拿到div底下的img
        var target = event.target; //控制圖片的div
        // console.log($(target).get(0).id); //拿到當前控制的ID
        x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;//重新設定x軸屬性
        outer_x = x;
        y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;//重新設定y軸屬性
        outer_y = y;
        document.getElementById("cellphono_info").innerHTML = "拿到當前控制的ID: " + $(target).get(0).id + " x: " + outer_x + " y: " + outer_y + "sacle : " + scale;
        // console.log("target x : ", event.dx, "target y : ", y); // 控制圖片的div 的 x,y軸印出
        target.style.webkitTransform = contoller_img.style.webkitTransform = 'translate(' + x + 'px, ' + y + 'px)'; // 控制圖片div 跟圖片一起 設定x,y軸屬性
        // target.style.webkitTransform = contoller_img.style.webkitTransform ='scale(' + scale + ')';

        // console.log(" target : ", target.style.webkitTransform, "contoller :", contoller_img.style.webkitTransform); //顯示設定的屬性
        // update the posiion attributes
        target.setAttribute('data-x', x);//重新data-x更新屬性
        target.setAttribute('data-y', y);//重新data-y更新屬性
    }

    function reset() {
        scale = 1;
        scaleElement.style.webkitTransform =
            scaleElement.style.transform =
            'scale(1)';
    }

    // var angle = 0; //角度
    // interact('.resize-drag').gesturable({ // 圖片外框  圖片旋轉
    //     onmove: function (event) {
    //         //dx， dy	改變鼠標/觸摸的坐標

    //         var contoller_img = document.getElementById("contoller"); //拿到div
    //         contoller_img = $(contoller_img).next().get(0); //拿到div底下的img
    //         var target = event.target; //控制圖片的div
    //         angle += event.da; //累加的旋轉速度

    //         target.style.webkitTransform = contoller_img.style.webkitTransform = 'rotate(' + angle + 'deg)'; //控制圖片的div 跟 img一起設定 旋轉角度 

    //         document.getElementById('angle-info').textContent = angle.toFixed(2) + '\u00b0'; //輸出轉的角度

    //     }
    // });


    function down() { //這個函數是點擊下載執行的方法
        html2canvas($(".resize-container"), { //這是使用了html2canvas這個插件的方法，將class為resize-container的整個節點繪製成畫布
            onrendered: function (canvas) { //畫布繪製完成後執行下面內容，function內的canvas這個參數就是已經被繪製成畫布 
                var link = document.createElement('a');//創建一個a標籤
                link.download = 'my-image-name.jpg';//a標籤增加一個download屬性，屬性值（my-image-name.jpg）就是合成下載後的文件名
                link.href = canvas.toDataURL();//canvas.toDataURL()就是畫布的路徑，將路徑賦給a標籤的href
                localStorage.setItem("img", link.href); //放置
                console.log(" 把圖片暫存到localStorage ", localStorage.getItem('img'));
                link.click();//模擬a標籤被點擊，這樣就可以下載了

            },
        }).then(canvas => { //做完後加元素
            document.body.appendChild(canvas) //加一個canvas 
        });
    }
    function FB_link() {
        window.location.href = "http://www.facebook.com/share.php?u=https://xinyan.000webhostapp.com/Mother/test.html"; //按到後分享圖片，到FB後按下後到網站
    };
    function Line_link() {
        window.location.href = "http://line.naver.jp/R/msg/text/?下次我要當海豹%0D%0Axinyan.000webhostapp.com/Mother/test.html"; //按到後分享圖片，到FB後按下後到網站
    };
    function combine() { //放置圖片位置會因為上傳大小導致放的地方有誤差
        var back = document.getElementById("back");//背景
        var canvas = document.getElementById("myCanvas"); //canvas
        canvas.width = back.width; //canvas 的寬 = 背景的寬
        canvas.height = back.height; //canvas 的高 = 背景的高
        var ctx = canvas.getContext("2d");//canvas必須打
        ctx.drawImage(back, 0, 0, back.width, back.height); //canvas畫出背景圖

        var upload_img = document.getElementById("portrait");//上傳的圖片
        ctx.drawImage(upload_img, 0, 0, upload_img.width, upload_img.height, (back.width / 2) - 80, (back.height / 2) - 50, upload_img.width, upload_img.height); //canvas畫出上傳的圖 做成疊圖

        // srccc = canvas.toDataURL("image/jpeg", 0.8);
        // console.log(srccc);
    }
    function showPreview(source, imgId) { //上傳圖片
        // console.log(source);
        var file = source.files[0];
        if (window.FileReader) {
            var fr = new FileReader();
            fr.onloadend = function (e) {
                document.getElementById(imgId).src = e.target.result; //把讀取到的照片放打imgID裡當來源
            }
            fr.readAsDataURL(file);
        }
    }
</script>

</html>